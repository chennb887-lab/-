name: Monitor Hanikorekhar Repository

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: å®‰è£…å¿…è¦å·¥å…·
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: æ£€æŸ¥ä»“åº“æ›´æ–°å’Œç‰ˆæœ¬å˜åŒ–
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          echo "BOT_TOKEN é•¿åº¦: ${#BOT_TOKEN}"
          echo "CHAT_ID: $CHAT_ID"
          
          OWNER="vampycloudia"
          REPO="hanikorekhar"
          LAST_COMMIT_FILE="last_commit.txt"
          LAST_VERSION_FILE="last_version.txt"

          # è·å–æœ€æ–°æäº¤ä¿¡æ¯
          LATEST_COMMIT=$(curl -s "https://api.github.com/repos/$OWNER/$REPO/commits/main")
          COMMIT_SHA=$(echo "$LATEST_COMMIT" | jq -r '.sha')
          COMMIT_SHA_SHORT=$(echo "$COMMIT_SHA" | cut -c1-7)
          COMMIT_URL="https://github.com/$OWNER/$REPO/commit/$COMMIT_SHA"
          REPO_URL="https://github.com/$OWNER/$REPO/tree/main"
          
          echo "æœ€æ–°æäº¤SHA: $COMMIT_SHA"
          echo "æäº¤é“¾æ¥: $COMMIT_URL"
          
          # è·å–æäº¤çš„è¯¦ç»†ä¿¡æ¯æ¥è·å–æ–‡ä»¶åˆ—è¡¨
          COMMIT_DETAIL=$(curl -s "https://api.github.com/repos/$OWNER/$REPO/commits/$COMMIT_SHA")
          FILES=$(echo "$COMMIT_DETAIL" | jq -r '.files[].filename' | tr '\n' ' ' || echo "")
          echo "æ–‡ä»¶åˆ—è¡¨: $FILES"

          # è·å– SrcVersion.ini æ–‡ä»¶å†…å®¹
          VERSION_FILE_URL="https://raw.githubusercontent.com/$OWNER/$REPO/main/SrcVersion.ini"
          VERSION_CONTENT=$(curl -s "$VERSION_FILE_URL" || echo "")
          
          # è§£æç‰ˆæœ¬ä¿¡æ¯
          STABLE_VERSION=$(echo "$VERSION_CONTENT" | grep "stable_channel" | cut -d'=' -f2 | tr -d ' ' || echo "")
          BETA_VERSION=$(echo "$VERSION_CONTENT" | grep "beta_channel" | cut -d'=' -f2 | tr -d ' ' || echo "")
          
          echo "ç¨³å®šç‰ˆæœ¬: $STABLE_VERSION"
          echo "æµ‹è¯•ç‰ˆæœ¬: $BETA_VERSION"

          # æ£€æŸ¥æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡è¿è¡Œ
          if [ ! -f "$LAST_COMMIT_FILE" ] || [ ! -f "$LAST_VERSION_FILE" ]; then
            echo "ç¬¬ä¸€æ¬¡è¿è¡Œï¼Œä¿å­˜å½“å‰çŠ¶æ€"
            echo "$COMMIT_SHA" > "$LAST_COMMIT_FILE"
            echo "$STABLE_VERSION|$BETA_VERSION" > "$LAST_VERSION_FILE"
            echo "âœ… åˆå§‹çŠ¶æ€å·²ä¿å­˜"
            
            # åªåœ¨ç¬¬ä¸€æ¬¡è¿è¡Œæ—¶å‘é€å¯åŠ¨æ¶ˆæ¯
            curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{\"chat_id\": \"$CHAT_ID\", \"text\": \"ğŸ”§ å®Œæ•´ç›‘æ§æœåŠ¡å·²å¯åŠ¨ï¼\\nä»“åº“: $OWNER/$REPO\\nå½“å‰ç¨³å®šç‰ˆæœ¬: $STABLE_VERSION\\nå½“å‰æµ‹è¯•ç‰ˆæœ¬: $BETA_VERSION\\n\\nå°†ç›‘æ§ï¼š\\n- æ–‡ä»¶æ›´æ–° (.so/.exe)\\n- ç‰ˆæœ¬å˜åŒ– (SrcVersion.ini)\"}"
            exit 0
          fi

          # è¯»å–ä¸Šæ¬¡ä¿å­˜çš„çŠ¶æ€
          LAST_SHA=$(cat "$LAST_COMMIT_FILE")
          LAST_VERSION_DATA=$(cat "$LAST_VERSION_FILE")
          LAST_STABLE=$(echo "$LAST_VERSION_DATA" | cut -d'|' -f1)
          LAST_BETA=$(echo "$LAST_VERSION_DATA" | cut -d'|' -f2)
          
          echo "ä¸Šæ¬¡æäº¤SHA: $LAST_SHA"
          echo "ä¸Šæ¬¡ç¨³å®šç‰ˆæœ¬: $LAST_STABLE"
          echo "ä¸Šæ¬¡æµ‹è¯•ç‰ˆæœ¬: $LAST_BETA"

          # åˆå§‹åŒ–æ¶ˆæ¯å˜é‡
          MESSAGE=""
          HAS_UPDATE=false
          FILE_UPDATES=""
          VERSION_CHANGES=""

          # æ¯”è¾ƒæäº¤SHA - æ£€æµ‹æ–‡ä»¶æ›´æ–°
          if [ "$COMMIT_SHA" != "$LAST_SHA" ]; then
            echo "ğŸš¨ æ£€æµ‹åˆ°æ–°æäº¤: $LAST_SHA -> $COMMIT_SHA"
            HAS_UPDATE=true
            
            # æ·»åŠ åŸºæœ¬æ›´æ–°ä¿¡æ¯
            MESSAGE="ğŸ“¢ ä»“åº“å·²æ›´æ–°ï¼\n\n"
            MESSAGE+="æäº¤: $COMMIT_SHA_SHORT\n"
            MESSAGE+="é“¾æ¥: $COMMIT_URL\n\n"
            
            # æ£€æŸ¥ç‰¹å®šæ–‡ä»¶æ›´æ–°
            for file in $FILES; do
              case "$file" in
                "IllI.exe")
                  FILE_UPDATES+="ğŸš¨ æ¨¡æ‹Ÿå™¨åŠ è½½å™¨å·²æ›´æ–°\n"
                  ;;
                "libvampy64.so")
                  FILE_UPDATES+="ğŸš¨ ç›´è£…äº‘å·²æ›´æ–°\n"
                  ;;
                "libvampybeta64.so")
                  FILE_UPDATES+="ğŸš¨ æµ‹è¯•ç‰ˆå·²æ›´æ–°\n"
                  ;;
                "SrcVersion.ini")
                  # ç‰ˆæœ¬æ–‡ä»¶æ›´æ–°ä¼šåœ¨ç‰ˆæœ¬æ¯”è¾ƒä¸­å¤„ç†
                  ;;
                *)
                  # å¿½ç•¥å…¶ä»–æ–‡ä»¶ï¼Œé™¤éæ˜¯é‡è¦æ–‡ä»¶
                  ;;
              esac
            done
            
            # ä¿å­˜æ–°æäº¤çŠ¶æ€
            echo "$COMMIT_SHA" > "$LAST_COMMIT_FILE"
          fi

          # æ¯”è¾ƒç‰ˆæœ¬ä¿¡æ¯
          if [ "$STABLE_VERSION" != "$LAST_STABLE" ] && [ -n "$STABLE_VERSION" ]; then
            echo "ğŸš¨ ç¨³å®šç‰ˆæœ¬æ›´æ–°: $LAST_STABLE -> $STABLE_VERSION"
            HAS_UPDATE=true
            
            if [ -z "$MESSAGE" ]; then
              MESSAGE="ğŸ“¢ ç‰ˆæœ¬æ›´æ–°é€šçŸ¥ï¼\n\n"
            fi
            
            VERSION_CHANGES+="âœ… ç¨³å®šé€šé“æ›´æ–°: $STABLE_VERSION\n"
            if [ -n "$LAST_STABLE" ]; then
              VERSION_CHANGES+="ä¹‹å‰ç‰ˆæœ¬: $LAST_STABLE\n"
            fi
            VERSION_CHANGES+="\n"
          fi

          if [ "$BETA_VERSION" != "$LAST_BETA" ] && [ -n "$BETA_VERSION" ]; then
            echo "ğŸš¨ æµ‹è¯•ç‰ˆæœ¬æ›´æ–°: $LAST_BETA -> $BETA_VERSION"
            HAS_UPDATE=true
            
            if [ -z "$MESSAGE" ]; then
              MESSAGE="ğŸ“¢ ç‰ˆæœ¬æ›´æ–°é€šçŸ¥ï¼\n\n"
            fi
            
            VERSION_CHANGES+="ğŸ§ª æµ‹è¯•é€šé“æ›´æ–°: $BETA_VERSION\n"
            if [ -n "$LAST_BETA" ]; then
              VERSION_CHANGES+="ä¹‹å‰ç‰ˆæœ¬: $LAST_BETA\n"
            fi
            VERSION_CHANGES+="\n"
          fi

          # åªæœ‰åœ¨æœ‰å®é™…æ›´æ–°æ—¶æ‰å‘é€æ¶ˆæ¯
          if [ "$HAS_UPDATE" = true ]; then
            # ä¿å­˜æ–°ç‰ˆæœ¬ä¿¡æ¯
            echo "$STABLE_VERSION|$BETA_VERSION" > "$LAST_VERSION_FILE"
            
            # ç»„åˆæ¶ˆæ¯
            if [ -n "$VERSION_CHANGES" ]; then
              MESSAGE+="ğŸ”„ ç‰ˆæœ¬æ›´æ–°:\n$VERSION_CHANGES"
            fi
            
            if [ -n "$FILE_UPDATES" ]; then
              MESSAGE+="ğŸ“ æ–‡ä»¶æ›´æ–°:\n$FILE_UPDATES"
            fi

            echo "å‘é€æ¶ˆæ¯: $MESSAGE"
            
            # å‘é€ Telegram æ¶ˆæ¯
            RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{\"chat_id\": \"$CHAT_ID\", \"text\": \"$MESSAGE\", \"parse_mode\": \"Markdown\"}")
            
            echo "Telegram API å“åº”: $RESPONSE"
            
          else
            echo "âœ… æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ–°ï¼Œä¸å‘é€é€šçŸ¥"
          fi
