name: Monitor Hanikorekhar Repository

on:
  schedule:
    - cron: "*/5 * * * *"   # æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
  workflow_dispatch:         # æ‰‹åŠ¨è§¦å‘

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: |
          sudo apt-get update || true
          sudo apt-get install -y jq || true

      - name: Check repository updates
        run: |
          OWNER="vampycloudia"
          REPO="hanikorekhar"
          LAST_FILE="last.txt"

          # è·å–æœ€æ–°æäº¤æ–‡ä»¶åˆ—è¡¨ï¼Œå‡ºé”™è¿”å›ç©ºå­—ç¬¦ä¸²
          FILES=$(curl -s https://api.github.com/repos/$OWNER/$REPO/commits/main | jq -r '.[0].files[].filename' || echo "")

          # ç¬¬ä¸€æ¬¡è¿è¡Œï¼Œä¿å­˜æ–‡ä»¶åˆ—è¡¨å¹¶é€€å‡º
          if [ ! -f $LAST_FILE ]; then
            echo "$FILES" > $LAST_FILE || true
            exit 0
          fi

          # è¯»å–ä¸Šæ¬¡ä¿å­˜çš„æ–‡ä»¶åˆ—è¡¨
          OLD=$(cat $LAST_FILE || echo "")

          # æ‰¾å‡ºæ›´æ–°æ–‡ä»¶
          UPDATED_FILES=$(comm -13 <(echo "$OLD" | sort) <(echo "$FILES" | sort) || true)

          if [ ! -z "$UPDATED_FILES" ]; then
            echo "$FILES" > $LAST_FILE || true

            # å¾ªç¯æ›´æ–°æ–‡ä»¶å‘é€ Telegram æé†’
            for file in $UPDATED_FILES; do
              if [ "$file" = "IllI.exe" ]; then
                MESSAGE="ğŸš¨ Emulator Loader updated: https://github.com/$OWNER/$REPO"
              elif [ "$file" = "libvampy64.so" ]; then
                MESSAGE="ğŸš¨ Direct Cloud updated: https://github.com/$OWNER/$REPO"
              elif [ "$file" = "libvampybeta64.so" ]; then
                MESSAGE="ğŸš¨ Beta version updated: https://github.com/$OWNER/$REPO"
              else
                MESSAGE="ğŸš¨ Repository updated: $file"
              fi

              # å‘é€ Telegram æ¶ˆæ¯
              curl -s -X POST "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
                -H "Content-Type: application/json" \
                -d "{\"chat_id\": \"${{ secrets.CHAT_ID }}\", \"text\": \"$MESSAGE\"}" || true
            done
          fi
