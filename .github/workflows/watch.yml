name: Repository Monitor

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Check updates
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          # 状态文件路径
          STATE_DIR=".github/monitor_state"
          LAST_COMMIT_FILE="$STATE_DIR/last_commit.txt"
          LAST_VERSION_FILE="$STATE_DIR/last_version.txt"
          
          # 创建状态目录
          mkdir -p "$STATE_DIR"
          
          # 仓库信息
          OWNER="vampycloudia"
          REPO="hanikorekhar"
          
          # 获取最新提交
          COMMIT_INFO=$(curl -s "https://api.github.com/repos/$OWNER/$REPO/commits/main")
          CURRENT_COMMIT=$(echo "$COMMIT_INFO" | jq -r '.sha')
          
          # 获取当前版本信息
          VERSION_CONTENT=$(curl -s "https://raw.githubusercontent.com/$OWNER/$REPO/main/SrcVersion.ini" || echo "")
          CURRENT_STABLE=$(echo "$VERSION_CONTENT" | grep "stable_channel" | cut -d'=' -f2 | tr -d ' ' || echo "获取失败")
          CURRENT_BETA=$(echo "$VERSION_CONTENT" | grep "beta_channel" | cut -d'=' -f2 | tr -d ' ' || echo "获取失败")
          
          echo "当前稳定版本: $CURRENT_STABLE"
          echo "当前测试版本: $CURRENT_BETA"
          
          # 检查上次提交
          if [ -f "$LAST_COMMIT_FILE" ]; then
            LAST_COMMIT=$(cat "$LAST_COMMIT_FILE")
          else
            # 第一次运行，保存状态并发送启动消息
            echo "$CURRENT_COMMIT" > "$LAST_COMMIT_FILE"
            echo "$CURRENT_STABLE|$CURRENT_BETA" > "$LAST_VERSION_FILE"
            
            # 发送启动消息
            START_MESSAGE="🔧 监控服务已启动\n当前稳定版本: $CURRENT_STABLE\n当前测试版本: $CURRENT_BETA"
            
            curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{\"chat_id\": \"$CHAT_ID\", \"text\": \"$START_MESSAGE\"}"
            
            echo "第一次运行，已发送启动消息"
            exit 0
          fi
          
          # 读取旧版本
          if [ -f "$LAST_VERSION_FILE" ]; then
            OLD_VERSIONS=$(cat "$LAST_VERSION_FILE")
            OLD_STABLE=$(echo "$OLD_VERSIONS" | cut -d'|' -f1)
            OLD_BETA=$(echo "$OLD_VERSIONS" | cut -d'|' -f2)
          else
            OLD_STABLE=""
            OLD_BETA=""
          fi
          
          # 检查是否有新提交
          if [ "$CURRENT_COMMIT" != "$LAST_COMMIT" ]; then
            # 有新提交，获取更新的文件
            COMMIT_DETAIL=$(curl -s "https://api.github.com/repos/$OWNER/$REPO/commits/$CURRENT_COMMIT")
            FILES=$(echo "$COMMIT_DETAIL" | jq -r '.files[].filename' | tr '\n' ' ' || echo "")
            
            # 构建更新消息
            MESSAGE=""
            
            # 检查文件更新
            if [[ "$FILES" == *"IllI.exe"* ]]; then
              MESSAGE+="模拟器加载器已更新\n"
            fi
            
            if [[ "$FILES" == *"libvampy64.so"* ]]; then
              MESSAGE+="直装云已更新\n"
            fi
            
            if [[ "$FILES" == *"libvampybeta64.so"* ]]; then
              MESSAGE+="测试版已更新\n"
            fi
            
            # 检查版本更新
            if [ -n "$CURRENT_STABLE" ] && [ -n "$OLD_STABLE" ] && [ "$CURRENT_STABLE" != "$OLD_STABLE" ]; then
              MESSAGE+="稳定通道更新: $OLD_STABLE → $CURRENT_STABLE\n"
            fi
            
            if [ -n "$CURRENT_BETA" ] && [ -n "$OLD_BETA" ] && [ "$CURRENT_BETA" != "$OLD_BETA" ]; then
              MESSAGE+="测试通道更新: $OLD_BETA → $CURRENT_BETA\n"
            fi
            
            # 如果有重要更新，发送通知
            if [ -n "$MESSAGE" ]; then
              # 发送更新通知
              curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
                -H "Content-Type: application/json" \
                -d "{\"chat_id\": \"$CHAT_ID\", \"text\": \"$MESSAGE\"}"
              
              echo "检测到更新，已发送通知"
            else
              echo "有新提交但没有重要文件或版本更新，不发送通知"
            fi
            
            # 保存新状态
            echo "$CURRENT_COMMIT" > "$LAST_COMMIT_FILE"
            echo "$CURRENT_STABLE|$CURRENT_BETA" > "$LAST_VERSION_FILE"
            
          else
            # 没有新提交
            if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
              # 手动触发但没有更新，发送当前状态
              STATUS_MESSAGE="📊 当前仓库状态\n稳定版本: $CURRENT_STABLE\n测试版本: $CURRENT_BETA\n\n无新更新"
              
              curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
                -H "Content-Type: application/json" \
                -d "{\"chat_id\": \"$CHAT_ID\", \"text\": \"$STATUS_MESSAGE\"}"
              
              echo "手动触发，已发送当前状态"
            else
              echo "没有检测到更新，不发送通知"
            fi
          fi
