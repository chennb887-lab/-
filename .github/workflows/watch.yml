name: Repository Monitor

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Restore state cache
        uses: actions/cache@v3
        with:
          path: |
            monitor_state.txt
            version_state.txt
          key: repo-monitor-state
          restore-keys: repo-monitor-state

      - name: Check for updates
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          STATE_FILE="monitor_state.txt"

          OWNER="vampycloudia"
          REPO="hanikorekhar"

          # èŽ·å–æœ€æ–° commit
          COMMIT=$(curl -s "https://api.github.com/repos/$OWNER/$REPO/commits/main")
          COMMIT_SHA=$(echo "$COMMIT" | jq -r '.sha')

          # è¯»å–ä¸Šæ¬¡ commit
          if [ -f "$STATE_FILE" ]; then
            LAST_SHA=$(cat "$STATE_FILE")
          else
            LAST_SHA=""
            echo "$COMMIT_SHA" > "$STATE_FILE"
            echo "é¦–æ¬¡ç›‘æŽ§ï¼Œè®°å½•ç‰ˆæœ¬åŽé€€å‡º"
            exit 0
          fi

          # æ²¡æ›´æ–°ç›´æŽ¥é€€å‡ºï¼ˆä¸ä¼šå‘é€šçŸ¥ï¼‰
          if [ "$COMMIT_SHA" = "$LAST_SHA" ]; then
            exit 0
          fi

          # ----------- ä½ çš„åŽŸé€»è¾‘ï¼šæ–‡ä»¶æ›´æ–°/ç‰ˆæœ¬æ›´æ–°é€šçŸ¥ -----------

          COMMIT_DETAIL=$(curl -s "https://api.github.com/repos/$OWNER/$REPO/commits/$COMMIT_SHA")
          FILES=$(echo "$COMMIT_DETAIL" | jq -r '.files[].filename' | tr '\n' ' ')

          MESSAGE=""
          UPDATED_FILES=""

          for file in $FILES; do
            case "$file" in
              "IllI.exe")
                UPDATED_FILES+="æ¨¡æ‹Ÿå™¨åŠ è½½å™¨\n"
                ;;
              "libvampy64.so")
                UPDATED_FILES+="ç›´è£…äº‘\n"
                ;;
              "libvampybeta64.so")
                UPDATED_FILES+="æµ‹è¯•ç‰ˆ\n"
                ;;
            esac
          done

          # æ£€æŸ¥ç‰ˆæœ¬æ–‡ä»¶
          if [[ "$FILES" == *"SrcVersion.ini"* ]]; then
            VERSION_CONTENT=$(curl -s "https://raw.githubusercontent.com/$OWNER/$REPO/main/SrcVersion.ini")
            STABLE_VERSION=$(echo "$VERSION_CONTENT" | grep "stable_channel" | cut -d'=' -f2 | tr -d ' ')
            BETA_VERSION=$(echo "$VERSION_CONTENT" | grep "beta_channel" | cut -d'=' -f2 | tr -d ' ')

            if [ -f "version_state.txt" ]; then
              OLD_STABLE=$(cut -d'|' -f1 version_state.txt)
              OLD_BETA=$(cut -d'|' -f2 version_state.txt)

              if [ "$STABLE_VERSION" != "$OLD_STABLE" ]; then
                MESSAGE+="âœ… ç¨³å®šé€šé“æ›´æ–°: $STABLE_VERSION\n"
              fi

              if [ "$BETA_VERSION" != "$OLD_BETA" ]; then
                MESSAGE+="ðŸ§ª æµ‹è¯•é€šé“æ›´æ–°: $BETA_VERSION\n"
              fi
            fi

            echo "$STABLE_VERSION|$BETA_VERSION" > version_state.txt
          fi

          if [ -n "$UPDATED_FILES" ]; then
            MESSAGE+="ðŸ“ æ–‡ä»¶æ›´æ–°:\n$UPDATED_FILES"
          fi

          # æœ‰æ¶ˆæ¯æ‰å‘é€
          if [ -n "$MESSAGE" ]; then
            curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{\"chat_id\": \"$CHAT_ID\", \"text\": \"$MESSAGE\"}"
          fi

          # ä¿å­˜æ–°çš„ commit çŠ¶æ€
          echo "$COMMIT_SHA" > "$STATE_FILE"

      - name: Save updated cache
        uses: actions/cache@v3
        with:
          path: |
            monitor_state.txt
            version_state.txt
          key: repo-monitor-state-${{ github.run_id }}
          restore-keys: repo-monitor-state
