name: Monitor Hanikorekhar Repository

on:
  schedule:
    - cron: "*/5 * * * *"   # æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
  workflow_dispatch:         # æ‰‹åŠ¨è§¦å‘

jobs:
  check:
    runs-on: ubuntu-latest
    env:
      BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
      CHAT_ID: ${{ secrets.CHAT_ID }}
    steps:
      - name: å®‰è£… jq
        run: |
          sudo apt-get update || true
          sudo apt-get install -y jq || true

      - name: æ£€æŸ¥ä»“åº“æ›´æ–°
        run: |
          OWNER="vampycloudia"
          REPO="hanikorekhar"
          LAST_FILE="last.txt"

          # è·å–æœ€æ–°æäº¤æ–‡ä»¶åˆ—è¡¨
          FILES=$(curl -s https://api.github.com/repos/$OWNER/$REPO/commits/main | jq -r '.[0].files[].filename' || echo "")

          # ç¬¬ä¸€æ¬¡è¿è¡Œï¼Œä¿å­˜æ–‡ä»¶åˆ—è¡¨å¹¶é€€å‡º
          if [ ! -f $LAST_FILE ]; then
            echo "$FILES" > $LAST_FILE
            exit 0
          fi

          # è¯»å–ä¸Šæ¬¡ä¿å­˜çš„æ–‡ä»¶åˆ—è¡¨
          OLD=$(cat $LAST_FILE)

          # æ‰¾å‡ºæ›´æ–°æ–‡ä»¶
          UPDATED_FILES=$(comm -13 <(echo "$OLD" | sort) <(echo "$FILES" | sort))

          if [ ! -z "$UPDATED_FILES" ]; then
            echo "$FILES" > $LAST_FILE

            for file in $UPDATED_FILES; do
              if [ "$file" = "IllI.exe" ]; then
                MESSAGE="ğŸš¨ æ¨¡æ‹Ÿå™¨åŠ è½½å™¨å·²æ›´æ–°: https://github.com/$OWNER/$REPO"
              elif [ "$file" = "libvampy64.so" ]; then
                MESSAGE="ğŸš¨ ç›´è£…äº‘å·²æ›´æ–°: https://github.com/$OWNER/$REPO"
              elif [ "$file" = "libvampybeta64.so" ]; then
                MESSAGE="ğŸš¨ æµ‹è¯•ç‰ˆå·²æ›´æ–°: https://github.com/$OWNER/$REPO"
              else
                MESSAGE="ğŸš¨ ä»“åº“å·²æ›´æ–°: $file"
              fi

              # å‘é€ Telegram æ¶ˆæ¯
              curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
                -H "Content-Type: application/json" \
                -d "{\"chat_id\": \"$CHAT_ID\", \"text\": \"$MESSAGE\"}"
            done
          fi
