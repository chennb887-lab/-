name: Repository Monitor

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Check for updates
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          # State file
          STATE_FILE="monitor_state.txt"
          
          # Repository info
          OWNER="vampycloudia"
          REPO="hanikorekhar"
          
          # Get latest commit
          COMMIT=$(curl -s "https://api.github.com/repos/$OWNER/$REPO/commits/main")
          COMMIT_SHA=$(echo "$COMMIT" | jq -r '.sha')
          
          # Read last commit
          if [ -f "$STATE_FILE" ]; then
            LAST_SHA=$(cat "$STATE_FILE")
          else
            LAST_SHA=""
            echo "$COMMIT_SHA" > "$STATE_FILE"
            echo "Starting repository monitoring"
            exit 0
          fi
          
          # Compare commits
          if [ "$COMMIT_SHA" = "$LAST_SHA" ]; then
            exit 0  # No update, exit quietly
          fi
          
          # Get updated files
          COMMIT_DETAIL=$(curl -s "https://api.github.com/repos/$OWNER/$REPO/commits/$COMMIT_SHA")
          FILES=$(echo "$COMMIT_DETAIL" | jq -r '.files[].filename' | tr '\n' ' ')
          
          # Check for specific files
          MESSAGE=""
          UPDATED_FILES=""
          
          # Check file updates
          for file in $FILES; do
            case "$file" in
              "IllI.exe")
                UPDATED_FILES+="æ¨¡æ‹Ÿå™¨åŠ è½½å™¨\n"
                ;;
              "libvampy64.so")
                UPDATED_FILES+="ç›´è£…äº‘\n"
                ;;
              "libvampybeta64.so")
                UPDATED_FILES+="æµ‹è¯•ç‰ˆ\n"
                ;;
            esac
          done
          
          # Check version update
          if [[ "$FILES" == *"SrcVersion.ini"* ]]; then
            VERSION_CONTENT=$(curl -s "https://raw.githubusercontent.com/$OWNER/$REPO/main/SrcVersion.ini")
            STABLE_VERSION=$(echo "$VERSION_CONTENT" | grep "stable_channel" | cut -d'=' -f2 | tr -d ' ')
            BETA_VERSION=$(echo "$VERSION_CONTENT" | grep "beta_channel" | cut -d'=' -f2 | tr -d ' ')
            
            # Try to read old versions
            if [ -f "version_state.txt" ]; then
              OLD_VERSIONS=$(cat "version_state.txt")
              OLD_STABLE=$(echo "$OLD_VERSIONS" | cut -d'|' -f1)
              OLD_BETA=$(echo "$OLD_VERSIONS" | cut -d'|' -f2)
              
              # Compare stable version
              if [ "$STABLE_VERSION" != "$OLD_STABLE" ]; then
                MESSAGE+="âœ… ç¨³å®šé€šé“æ›´æ–°: $STABLE_VERSION\n"
              fi
              
              # Compare beta version
              if [ "$BETA_VERSION" != "$OLD_BETA" ]; then
                MESSAGE+="ðŸ§ª æµ‹è¯•é€šé“æ›´æ–°: $BETA_VERSION\n"
              fi
            fi
            
            # Save new versions
            echo "$STABLE_VERSION|$BETA_VERSION" > "version_state.txt"
          fi
          
          # If there are file updates
          if [ -n "$UPDATED_FILES" ]; then
            if [ -n "$MESSAGE" ]; then
              MESSAGE+="\nðŸ“ æ–‡ä»¶æ›´æ–°:\n$UPDATED_FILES"
            else
              MESSAGE="ðŸ“ æ–‡ä»¶æ›´æ–°:\n$UPDATED_FILES"
            fi
          fi
          
          # Send notification if there are updates
          if [ -n "$MESSAGE" ]; then
            # Send notification
            curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{\"chat_id\": \"$CHAT_ID\", \"text\": \"$MESSAGE\"}"
            
            # Save new state
            echo "$COMMIT_SHA" > "$STATE_FILE"
          fi
