name: Repository Monitor

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Check updates
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          # 状态文件路径
          STATE_DIR=".github/monitor_state"
          LAST_COMMIT_FILE="$STATE_DIR/last_commit.txt"
          LAST_VERSION_FILE="$STATE_DIR/last_version.txt"
          
          # 创建状态目录
          mkdir -p "$STATE_DIR"
          
          # 仓库信息
          OWNER="vampycloudia"
          REPO="hanikorekhar"
          
          # 获取最新提交
          COMMIT_INFO=$(curl -s "https://api.github.com/repos/$OWNER/$REPO/commits/main")
          CURRENT_COMMIT=$(echo "$COMMIT_INFO" | jq -r '.sha')
          
          # 检查上次提交
          if [ -f "$LAST_COMMIT_FILE" ]; then
            LAST_COMMIT=$(cat "$LAST_COMMIT_FILE")
          else
            # 第一次运行，保存状态并退出，不发送任何通知
            echo "$CURRENT_COMMIT" > "$LAST_COMMIT_FILE"
            
            # 获取并保存版本信息
            VERSION_CONTENT=$(curl -s "https://raw.githubusercontent.com/$OWNER/$REPO/main/SrcVersion.ini" || echo "")
            STABLE_VERSION=$(echo "$VERSION_CONTENT" | grep "stable_channel" | cut -d'=' -f2 | tr -d ' ' || echo "")
            BETA_VERSION=$(echo "$VERSION_CONTENT" | grep "beta_channel" | cut -d'=' -f2 | tr -d ' ' || echo "")
            echo "$STABLE_VERSION|$BETA_VERSION" > "$LAST_VERSION_FILE"
            
            echo "第一次运行，已保存初始状态"
            exit 0
          fi
          
          # 如果没有新提交，安静退出
          if [ "$CURRENT_COMMIT" = "$LAST_COMMIT" ]; then
            exit 0
          fi
          
          # 获取更新的文件
          COMMIT_DETAIL=$(curl -s "https://api.github.com/repos/$OWNER/$REPO/commits/$CURRENT_COMMIT")
          FILES=$(echo "$COMMIT_DETAIL" | jq -r '.files[].filename' | tr '\n' ' ' || echo "")
          
          # 获取当前版本
          VERSION_CONTENT=$(curl -s "https://raw.githubusercontent.com/$OWNER/$REPO/main/SrcVersion.ini" || echo "")
          CURRENT_STABLE=$(echo "$VERSION_CONTENT" | grep "stable_channel" | cut -d'=' -f2 | tr -d ' ' || echo "")
          CURRENT_BETA=$(echo "$VERSION_CONTENT" | grep "beta_channel" | cut -d'=' -f2 | tr -d ' ' || echo "")
          
          # 读取旧版本
          if [ -f "$LAST_VERSION_FILE" ]; then
            OLD_VERSIONS=$(cat "$LAST_VERSION_FILE")
            OLD_STABLE=$(echo "$OLD_VERSIONS" | cut -d'|' -f1)
            OLD_BETA=$(echo "$OLD_VERSIONS" | cut -d'|' -f2)
          else
            OLD_STABLE=""
            OLD_BETA=""
          fi
          
          # 构建消息
          MESSAGE=""
          
          # 检查文件更新
          if [[ "$FILES" == *"IllI.exe"* ]]; then
            MESSAGE+="模拟器加载器已更新\n"
          fi
          
          if [[ "$FILES" == *"libvampy64.so"* ]]; then
            MESSAGE+="直装云已更新\n"
          fi
          
          if [[ "$FILES" == *"libvampybeta64.so"* ]]; then
            MESSAGE+="测试版已更新\n"
          fi
          
          # 检查版本更新
          if [ -n "$CURRENT_STABLE" ] && [ -n "$OLD_STABLE" ] && [ "$CURRENT_STABLE" != "$OLD_STABLE" ]; then
            MESSAGE+="稳定通道更新: $CURRENT_STABLE\n"
          fi
          
          if [ -n "$CURRENT_BETA" ] && [ -n "$OLD_BETA" ] && [ "$CURRENT_BETA" != "$OLD_BETA" ]; then
            MESSAGE+="测试通道更新: $CURRENT_BETA\n"
          fi
          
          # 如果没有检测到重要更新，只更新状态不发送通知
          if [ -z "$MESSAGE" ]; then
            # 保存新状态但不发送通知
            echo "$CURRENT_COMMIT" > "$LAST_COMMIT_FILE"
            echo "$CURRENT_STABLE|$CURRENT_BETA" > "$LAST_VERSION_FILE"
            exit 0
          fi
          
          # 发送通知
          curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\": \"$CHAT_ID\", \"text\": \"$MESSAGE\"}"
          
          # 保存新状态
          echo "$CURRENT_COMMIT" > "$LAST_COMMIT_FILE"
          echo "$CURRENT_STABLE|$CURRENT_BETA" > "$LAST_VERSION_FILE"
