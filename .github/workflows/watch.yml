name: Monitor Hanikorekhar Repository

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: 安装必要工具
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: 检查仓库更新和版本变化
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          # 调试信息：检查环境变量是否设置
          echo "BOT_TOKEN 长度: ${#BOT_TOKEN}"
          echo "CHAT_ID: $CHAT_ID"
          
          OWNER="vampycloudia"
          REPO="hanikorekhar"
          LAST_COMMIT_FILE="last_commit.txt"
          LAST_VERSION_FILE="last_version.txt"

          # 获取最新提交信息
          LATEST_COMMIT=$(curl -s "https://api.github.com/repos/$OWNER/$REPO/commits/main")
          COMMIT_SHA=$(echo "$LATEST_COMMIT" | jq -r '.sha' | cut -c1-7)
          COMMIT_URL=$(echo "$LATEST_COMMIT" | jq -r '.html_url')
          
          echo "最新提交SHA: $COMMIT_SHA"
          
          # 获取 SrcVersion.ini 文件内容
          VERSION_FILE_URL="https://raw.githubusercontent.com/$OWNER/$REPO/main/SrcVersion.ini"
          VERSION_CONTENT=$(curl -s "$VERSION_FILE_URL" || echo "")
          
          echo "版本文件内容:"
          echo "$VERSION_CONTENT"
          
          # 解析版本信息
          STABLE_VERSION=$(echo "$VERSION_CONTENT" | grep "stable_channel" | cut -d'=' -f2 | tr -d ' ' || echo "")
          BETA_VERSION=$(echo "$VERSION_CONTENT" | grep "beta_channel" | cut -d'=' -f2 | tr -d ' ' || echo "")
          
          echo "稳定版本: $STABLE_VERSION"
          echo "测试版本: $BETA_VERSION"

          # 检查是否是第一次运行
          if [ ! -f "$LAST_COMMIT_FILE" ] || [ ! -f "$LAST_VERSION_FILE" ]; then
            echo "第一次运行，保存当前状态"
            echo "$COMMIT_SHA" > "$LAST_COMMIT_FILE"
            echo "$STABLE_VERSION|$BETA_VERSION" > "$LAST_VERSION_FILE"
            echo "✅ 初始状态已保存"
            
            # 发送启动消息
            curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{\"chat_id\": \"$CHAT_ID\", \"text\": \"🔧 版本监控服务已启动！\\n仓库: $OWNER/$REPO\\n当前稳定版本: $STABLE_VERSION\\n当前测试版本: $BETA_VERSION\"}"
            exit 0
          fi

          # 读取上次保存的状态
          LAST_SHA=$(cat "$LAST_COMMIT_FILE")
          LAST_VERSION_DATA=$(cat "$LAST_VERSION_FILE")
          LAST_STABLE=$(echo "$LAST_VERSION_DATA" | cut -d'|' -f1)
          LAST_BETA=$(echo "$LAST_VERSION_DATA" | cut -d'|' -f2)
          
          echo "上次提交SHA: $LAST_SHA"
          echo "上次稳定版本: $LAST_STABLE"
          echo "上次测试版本: $LAST_BETA"

          # 初始化消息变量
          MESSAGE=""
          HAS_UPDATE=false

          # 比较提交SHA
          if [ "$COMMIT_SHA" != "$LAST_SHA" ]; then
            echo "🚨 检测到新提交: $LAST_SHA -> $COMMIT_SHA"
            HAS_UPDATE=true
            
            # 保存新状态
            echo "$COMMIT_SHA" > "$LAST_COMMIT_FILE"
            
            # 添加基本更新信息
            MESSAGE="📢 仓库已更新！\n\n"
            MESSAGE+="提交: $COMMIT_SHA\n"
            MESSAGE+="链接: $COMMIT_URL\n\n"
          fi

          # 比较版本信息
          if [ "$STABLE_VERSION" != "$LAST_STABLE" ] && [ -n "$STABLE_VERSION" ]; then
            echo "🚨 稳定版本更新: $LAST_STABLE -> $STABLE_VERSION"
            HAS_UPDATE=true
            
            if [ -z "$MESSAGE" ]; then
              MESSAGE="📢 版本更新通知！\n\n"
            fi
            
            MESSAGE+="✅ 稳定通道更新: $STABLE_VERSION\n"
            if [ -n "$LAST_STABLE" ]; then
              MESSAGE+="之前版本: $LAST_STABLE\n"
            fi
            MESSAGE+="\n"
          fi

          if [ "$BETA_VERSION" != "$LAST_BETA" ] && [ -n "$BETA_VERSION" ]; then
            echo "🚨 测试版本更新: $LAST_BETA -> $BETA_VERSION"
            HAS_UPDATE=true
            
            if [ -z "$MESSAGE" ]; then
              MESSAGE="📢 版本更新通知！\n\n"
            fi
            
            MESSAGE+="🧪 测试通道更新: $BETA_VERSION\n"
            if [ -n "$LAST_BETA" ]; then
              MESSAGE+="之前版本: $LAST_BETA\n"
            fi
            MESSAGE+="\n"
          fi

          # 如果有更新，发送消息并保存新版本信息
          if [ "$HAS_UPDATE" = true ]; then
            # 保存新版本信息
            echo "$STABLE_VERSION|$BETA_VERSION" > "$LAST_VERSION_FILE"
            
            # 如果没有具体的版本更新信息，添加通用消息
            if [ -z "$MESSAGE" ]; then
              MESSAGE="📢 检测到仓库更新，但版本文件无变化\n"
              MESSAGE+="提交: $COMMIT_SHA\n"
              MESSAGE+="链接: $COMMIT_URL"
            fi

            echo "发送消息: $MESSAGE"
            
            # 发送 Telegram 消息
            RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{\"chat_id\": \"$CHAT_ID\", \"text\": \"$MESSAGE\", \"parse_mode\": \"Markdown\"}")
            
            echo "Telegram API 响应: $RESPONSE"
            
          else
            echo "✅ 没有检测到更新"
          fi
