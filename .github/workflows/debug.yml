name: Debug Monitor Hanikorekhar Repository

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: 安装必要工具
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: 检查仓库更新
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          echo "=== 开始调试 ==="
          echo "当前时间: $(date)"
          echo "触发类型: ${{ github.event_name }}"
          
          # 仓库信息
          OWNER="vampycloudia"
          REPO="hanikorekhar"
          
          echo "=== 获取最新提交 ==="
          LATEST_COMMIT=$(curl -s "https://api.github.com/repos/$OWNER/$REPO/commits/main")
          echo "API响应: $LATEST_COMMIT"
          
          COMMIT_SHA=$(echo "$LATEST_COMMIT" | jq -r '.sha')
          echo "最新提交SHA: $COMMIT_SHA"
          
          # 获取提交详情
          echo "=== 获取提交详情 ==="
          COMMIT_DETAIL=$(curl -s "https://api.github.com/repos/$OWNER/$REPO/commits/$COMMIT_SHA")
          echo "提交详情: $COMMIT_DETAIL"
          
          FILES=$(echo "$COMMIT_DETAIL" | jq -r '.files[].filename' || echo "")
          echo "更新的文件列表: $FILES"
          
          # 检查特定文件
          echo "=== 检查特定文件 ==="
          for file in $FILES; do
            echo "文件: $file"
            case "$file" in
              "IllI.exe")
                echo "✅ 发现 IllI.exe"
                ;;
              "libvampy64.so")
                echo "✅ 发现 libvampy64.so"
                ;;
              "libvampybeta64.so")
                echo "✅ 发现 libvampybeta64.so"
                ;;
              "ScrVersion.ini")
                echo "✅ 发现 ScrVersion.ini"
                ;;
            esac
          done
          
          # 获取版本文件
          echo "=== 获取版本文件 ==="
          VERSION_FILE_URL="https://raw.githubusercontent.com/$OWNER/$REPO/main/ScrVersion.ini"
          echo "版本文件URL: $VERSION_FILE_URL"
          
          VERSION_CONTENT=$(curl -s "$VERSION_FILE_URL" || echo "获取失败")
          echo "版本文件内容:"
          echo "$VERSION_CONTENT"
          
          # 解析版本
          STABLE_VERSION=$(echo "$VERSION_CONTENT" | grep "Release_channel" | cut -d'=' -f2 | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' || echo "未找到")
          BETA_VERSION=$(echo "$VERSION_CONTENT" | grep "Dev_channel" | cut -d'=' -f2 | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' || echo "未找到")
          
          echo "解析的稳定版本: '$STABLE_VERSION'"
          echo "解析的测试版本: '$BETA_VERSION'"
          
          # 检查状态文件
          echo "=== 检查状态文件 ==="
          STATE_DIR=".github/monitor_state"
          LAST_COMMIT_FILE="$STATE_DIR/last_commit.txt"
          LAST_VERSION_FILE="$STATE_DIR/last_version.txt"
          
          mkdir -p "$STATE_DIR"
          
          if [ -f "$LAST_COMMIT_FILE" ]; then
            LAST_SHA=$(cat "$LAST_COMMIT_FILE")
            echo "上次提交SHA: $LAST_SHA"
          else
            echo "状态文件不存在，创建中..."
            echo "$COMMIT_SHA" > "$LAST_COMMIT_FILE"
            echo "$STABLE_VERSION|$BETA_VERSION" > "$LAST_VERSION_FILE"
            echo "✅ 初始状态已保存"
            exit 0
          fi
          
          if [ -f "$LAST_VERSION_FILE" ]; then
            LAST_VERSION_DATA=$(cat "$LAST_VERSION_FILE")
            LAST_STABLE=$(echo "$LAST_VERSION_DATA" | cut -d'|' -f1)
            LAST_BETA=$(echo "$LAST_VERSION_DATA" | cut -d'|' -f2)
            echo "上次稳定版本: '$LAST_STABLE'"
            echo "上次测试版本: '$LAST_BETA'"
          fi
          
          # 比较提交
          echo "=== 比较提交 ==="
          if [ "$COMMIT_SHA" != "$LAST_SHA" ] && [ -n "$LAST_SHA" ]; then
            echo "🚨 检测到新提交！"
            echo "旧: $LAST_SHA"
            echo "新: $COMMIT_SHA"
            
            # 构建消息
            MESSAGE=""
            
            # 检查文件更新
            for file in $FILES; do
              case "$file" in
                "IllI.exe")
                  MESSAGE+="模拟器加载器已更新\n"
                  ;;
                "libvampy64.so")
                  MESSAGE+="直装已更新\n"
                  ;;
                "libvampybeta64.so")
                  MESSAGE+="测试版已更新\n"
                  ;;
              esac
            done
            
            # 检查版本更新
            if [ -n "$STABLE_VERSION" ] && [ -n "$LAST_STABLE" ] && [ "$STABLE_VERSION" != "$LAST_STABLE" ]; then
              MESSAGE+="稳定通道更新: $LAST_STABLE → $STABLE_VERSION\n"
            fi
            
            if [ -n "$BETA_VERSION" ] && [ -n "$LAST_BETA" ] && [ "$BETA_VERSION" != "$LAST_BETA" ]; then
              MESSAGE+="测试通道更新: $LAST_BETA → $BETA_VERSION\n"
            fi
            
            echo "构建的消息:"
            echo "$MESSAGE"
            
            if [ -n "$MESSAGE" ]; then
              echo "准备发送通知..."
              
              # 发送通知
              curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
                -H "Content-Type: application/json" \
                -d "{\"chat_id\": \"$CHAT_ID\", \"text\": \"$MESSAGE\"}"
              
              echo "✅ 已发送通知"
              
              # 保存新状态
              echo "$COMMIT_SHA" > "$LAST_COMMIT_FILE"
              echo "$STABLE_VERSION|$BETA_VERSION" > "$LAST_VERSION_FILE"
            else
              echo "⚠️ 没有重要文件或版本更新，不发送通知"
              echo "$COMMIT_SHA" > "$LAST_COMMIT_FILE"
            fi
            
          else
            echo "✅ 没有新提交"
          fi
          
          echo "=== 调试结束 ==="
