name: Monitor Hanikorekhar Repository

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: 安装必要工具
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: 恢复缓存状态
        uses: actions/cache@v3
        with:
          path: |
            .github/monitor_state
          key: monitor-state-${{ github.ref }}

      - name: 检查仓库更新
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          echo "=== 监控脚本开始 ==="
          
          OWNER="vampycloudia"
          REPO="hanikorekhar"
          STATE_DIR=".github/monitor_state"
          LAST_COMMIT_FILE="$STATE_DIR/last_commit.txt"
          LAST_VERSION_FILE="$STATE_DIR/last_version.txt"
          
          mkdir -p "$STATE_DIR"
          
          # 获取最新提交
          LATEST_COMMIT=$(curl -s "https://api.github.com/repos/$OWNER/$REPO/commits/main")
          CURRENT_SHA=$(echo "$LATEST_COMMIT" | jq -r '.sha')
          echo "当前提交: $CURRENT_SHA"
          
          # 获取更新的文件列表
          COMMIT_DETAIL=$(curl -s "https://api.github.com/repos/$OWNER/$REPO/commits/$CURRENT_SHA")
          FILES=$(echo "$COMMIT_DETAIL" | jq -r '.files[].filename' 2>/dev/null | tr '\n' ' ' || echo "")
          echo "涉及文件: $FILES"
          
          # 获取并解析版本文件
          VERSION_URL="https://raw.githubusercontent.com/$OWNER/$REPO/main/SrcVersion.ini"
          VERSION_CONTENT=$(curl -s "$VERSION_URL" || echo "")
          
          STABLE_VER=$(echo "$VERSION_CONTENT" | grep "Release_channel" | cut -d'=' -f2 | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          BETA_VER=$(echo "$VERSION_CONTENT" | grep "Dev_channel"   | cut -d'=' -f2 | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          
          echo "解析稳定版: '$STABLE_VER'"
          echo "解析测试版: '$BETA_VER'"
          
          # 初始化：首次运行或状态文件缺失
          if [ ! -f "$LAST_COMMIT_FILE" ] || [ ! -f "$LAST_VERSION_FILE" ]; then
            echo "初始化：保存当前状态。"
            echo "$CURRENT_SHA" > "$LAST_COMMIT_FILE"
            echo "$STABLE_VER|$BETA_VER" > "$LAST_VERSION_FILE"
            
            INIT_MSG="🔧 仓库监控已启动\n稳定版本: $STABLE_VER\n测试版本: $BETA_VER"
            curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{\"chat_id\": \"$CHAT_ID\", \"text\": \"$INIT_MSG\"}"
            
            echo "✅ 初始状态已保存，启动通知已发送。"
            echo "=== 监控脚本结束 ==="
            exit 0
          fi
          
          # 读取上次保存的状态
          LAST_SHA=$(cat "$LAST_COMMIT_FILE" 2>/dev/null || echo "")
          LAST_VER_DATA=$(cat "$LAST_VERSION_FILE" 2>/dev/null || echo "|")
          OLD_STABLE=$(echo "$LAST_VER_DATA" | cut -d'|' -f1)
          OLD_BETA=$(echo "$LAST_VER_DATA" | cut -d'|' -f2)
          
          echo "上次提交: $LAST_SHA"
          echo "上次稳定: '$OLD_STABLE'"
          echo "上次测试: '$OLD_BETA'"
          
          # 检测新提交
          if [ "$CURRENT_SHA" != "$LAST_SHA" ] && [ -n "$LAST_SHA" ]; then
            echo "🚨 发现新提交，开始分析..."
            NOTIFICATION=""
            
            # 检查特定文件更新
            for FILE in $FILES; do
              case "$FILE" in
                "IllI.exe")
                  NOTIFICATION+="模拟器加载器已更新\n"
                  ;;
                "libvampy64.so")
                  NOTIFICATION+="直装已更新\n"
                  ;;
                "libvampybeta64.so")
                  NOTIFICATION+="测试版已更新\n"
                  ;;
              esac
            done
            
            # 检查版本号变化 - 使用新格式（类型和版本分两行）
            if [ -n "$STABLE_VER" ] && [ -n "$OLD_STABLE" ] && [ "$STABLE_VER" != "$OLD_STABLE" ]; then
              echo "稳定版本变化: $OLD_STABLE -> $STABLE_VER"
              [ -n "$NOTIFICATION" ] && NOTIFICATION+="\n"
              NOTIFICATION+="稳定通道更新:\n$OLD_STABLE → $STABLE_VER\n"
            fi
            
            if [ -n "$BETA_VER" ] && [ -n "$OLD_BETA" ] && [ "$BETA_VER" != "$OLD_BETA" ]; then
              echo "测试版本变化: $OLD_BETA -> $BETA_VER"
              [ -n "$NOTIFICATION" ] && NOTIFICATION+="\n"
              NOTIFICATION+="测试通道更新:\n$OLD_BETA → $BETA_VER\n"
            fi
            
            # 发送通知（如果有内容）
            if [ -n "$NOTIFICATION" ]; then
              echo "📤 发送通知..."
              curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
                -H "Content-Type: application/json" \
                -d "{\"chat_id\": \"$CHAT_ID\", \"text\": \"$NOTIFICATION\"}"
              echo "✅ 通知已发送。"
            else
              echo "ℹ️  新提交未包含监控目标，本次静默。"
            fi
            
            # 更新状态文件
            echo "$CURRENT_SHA" > "$LAST_COMMIT_FILE"
            echo "$STABLE_VER|$BETA_VER" > "$LAST_VERSION_FILE"
            echo "状态已更新。"
            
          else
            echo "✅ 已是最新状态，无新提交。"
          fi
          
          echo "=== 监控脚本结束 ==="
